@page "/debt"
@using BudgetBhasan.Models
@using BudgetBhasan.Services


@inject Database DatabaseService
@inject NavigationManager NavigationManager
@inject IJSRuntime JSRuntime


<link href="css/Debt.css" rel="stylesheet" />

<div class="debt-container">
    <h2>Debt</h2>
    <div class="summary-cards">
        <div class="card">
            <h3>Current Balance</h3>
            <p>Rs @currentBalance</p>
        </div>
        <div class="card">
            <h3>Your Remaining Debts</h3>
            <p>Rs @totalUnpaidDebt</p>
            <button @onclick="NavigateToAddDebt">Take Debt</button>
        </div>
    </div>

    <h3>Transactions</h3>
    @if (!string.IsNullOrEmpty(errorMessage))
    {
        <div class="error-message">@errorMessage</div>
    }
    @if (debts == null)
    {
        <p>Loading debts...</p>
    }
    else if (!debts.Any())
    {
        <p>No unpaid debts found.</p>
    }
    else
    {
        <table class="transaction-table">
            <thead>
                <tr>
                    <th>Taken From</th>
                    <th>
                        Date Taken 
                    </th>
                    <th>
                        Due Date
                    </th>
                    <th>
                        Amount
                    </th>
                    <th>Repay</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var debt in debts)
                {
                    <tr>
                        <td>@debt.TakenFrom</td>
                        <td>@debt.DateTaken.ToString("yyyy/MM/dd")</td>
                        <td>@debt.DueDate.ToString("yyyy/MM/dd")</td>
                        <td>Rs @debt.Amount</td>
                        <td>
                            <button @onclick="() => ConfirmRepayment(debt)">Repay</button>
                        </td>
                    </tr>
                }
            </tbody>
        </table>
    }
</div>

@code {
    private List<Debt> debts;
    private int currentBalance;
    private int totalUnpaidDebt;
    private string errorMessage;
    private List<Outflow> filteredDebts;

    protected override async Task OnInitializedAsync()
    {
        await LoadUserBalanceAsync();
        await LoadDebtsAsync();
    }

    private async Task LoadUserBalanceAsync()
    {
        try
        {
            var users = await DatabaseService.GetAllUsersAsync();
            var currentUser = users.FirstOrDefault();

            if (currentUser != null)
            {
                currentBalance = currentUser.Balance;
            }
            else
            {
                currentBalance = 0;
                Console.WriteLine("No user found in the database.");
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error fetching user balance: {ex.Message}");
            currentBalance = 0;
        }
    }

    private async Task LoadDebtsAsync()
    {
        try
        {
            var allDebts = await DatabaseService.GetAllDebtsAsync();
            debts = allDebts.Where(d => d.IsPaid == "False").ToList();
            totalUnpaidDebt = debts.Sum(d => d.Amount);
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading debts: {ex.Message}");
            debts = new List<Debt>();
            totalUnpaidDebt = 0;
        }
    }
    
    //When repay button is clicked confirming if user really wants to repay his/her debt
    private async Task ConfirmRepayment(Debt debt)
    {
        bool isConfirmed = await JSRuntime.InvokeAsync<bool>("confirm", $"Are you sure you want to repay Rs {debt.Amount}?");
        if (isConfirmed)
        {
            await HandleRepayment(debt);
        }
    }

    private async Task HandleRepayment(Debt debt)
    {
        //Checking if user's balance is greater than user's debt amount
        if (currentBalance >= debt.Amount)
        {
            try
            {
                // Deducting the amount from the user's balance in user table
                currentBalance -= debt.Amount;

                // Update the user's balance in the user table in database
                var users = await DatabaseService.GetAllUsersAsync();
                var currentUser = users.FirstOrDefault();
                if (currentUser != null)
                {
                    currentUser.Balance = currentBalance;
                    await DatabaseService.UpdateUserAsync(currentUser);
                }

                // Mark the debt as paid using DebtId
                var debtToUpdate = await DatabaseService.GetDebtByIdAsync(debt.debtId);
                if (debtToUpdate != null)
                {
                    debtToUpdate.IsPaid = "true"; // Changing the value of isPaid to true when debt is paid inorder to remove from debt table and showing data in debt history page
                    await DatabaseService.UpdateDebtAsync(debtToUpdate);
                }

                // Reload debts and clear error message
                await LoadDebtsAsync();
                errorMessage = string.Empty;
            }
            catch (Exception ex)
            {
                Console.WriteLine($"Error handling repayment: {ex.Message}");
                errorMessage = "An error occurred while processing your repayment.";
            }
        }
        else
        {
            errorMessage = "Not enough money to repay this debt.";
        }
    }
    private void NavigateToAddDebt()
    {
        NavigationManager.NavigateTo("/adddebt");
    }
}
